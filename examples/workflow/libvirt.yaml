wasser:
  version: '1.0'

routines:
  libvirt-leap:
    steps:
    # we need preliminary dependencies on the minimal image,
    # because we do not prepare wasser ready images and take
    # stock leap image
    - name: install dependencies
      command: |
        for i in {1..5} ; do ping -q -c1 download.opensuse.org && break ; sleep 3 ; done
        sudo zypper --no-gpg-checks ref
        sudo zypper install -y git
    # also we need 'kernel-default' instead of 'kernel-default-base' for Leap
    # in order to have nested virtualisation working
    - name: install default kernel for kvm
      command: |
        sudo zypper remove -y kernel-default-base
        sudo zypper install -y kernel-default
    - name: install kvm/qemu and libvirt
      command:
        sudo zypper -n install -t pattern kvm_server kvm_tools
    - reboot
    - wait_host
    - name: install libvirt specific packages
      command: |
        sudo zypper install -y qemu-kvm polkit 2>&1
    - name: add user to wheel group to allow passwordless access to libvirt
      command: |
        sudo usermod -a -G wheel $USER
    - name: allow users in wheel group to manage the libvirt daemon without authentication
      command: |
        sudo tee /etc/polkit-1/rules.d/50-libvirt.rules << END
        polkit.addRule(function(action, subject) {
            if (action.id == "org.libvirt.unix.manage" &&
            subject.isInGroup("wheel")) {
                return polkit.Result.YES;
            }
        });

        END
    - name: make sure libvirtd is running
      command: |
        sudo systemctl enable libvirtd
        sudo systemctl start libvirtd
    - name: add default pool
      command: |
        sudo virsh pool-define /dev/stdin <<EOF
        <pool type='dir'>
          <name>default</name>
          <target>
            <path>/var/lib/libvirt/images</path>
          </target>
        </pool>
        EOF
    - name: make sure default pool is running
      command: |
        sudo virsh pool-start default
        sudo virsh pool-autostart default

openstack:
  flavor: s1-8
  #image-source: "https://download.opensuse.org/distribution/leap/15.4/appliances/openSUSE-Leap-15.4-JeOS.x86_64-15.4-OpenStack-Cloud-Build31.185.qcow2"
  image-source: "https://download.opensuse.org/distribution/leap/15.4/appliances/openSUSE-Leap-15.4-JeOS.x86_64-OpenStack-Cloud.qcow2"
  image: openSUSE-Leap-15.4-JeOS.x86_64
  keyfile: ~/.ssh/sa3
  keyname: sa3
  name: "opensuse-%02d"
  userdata: openstack/user-data.yaml
  username: opensuse
